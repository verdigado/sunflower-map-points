(()=>{"use strict";const e=window.wp.i18n;document.addEventListener("DOMContentLoaded",()=>{new MutationObserver(()=>{document.querySelectorAll(".map-container").forEach(t=>{if("undefined"==typeof L)return void console.error((0,e.__)("Leaflet is not available","sunflower-map-points-map"));const o=t.querySelector("#map");if(!o)return;if(o&&o._leaflet_id)return;const n=parseFloat(t.dataset.lat),a=parseFloat(t.dataset.lng),r=parseInt(t.dataset.zoom,10),l=L.map(o,{scrollWheelZoom:!0,dragging:!0,fullscreenControl:!0}).setView([n,a],r);o._leafletMap=l,L.Control.LocateControl=L.Control.extend({onAdd(){const e=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom");return e.innerHTML='<i class="fa-solid fa-location-crosshairs"></i>',e.style.backgroundColor="white",e.style.width="34px",e.style.height="34px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.cursor="pointer",e.onclick=function(){l.locate({setView:!0,maxZoom:15})},L.DomEvent.disableClickPropagation(e),e}}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'}).addTo(l),l.addControl(new L.Control.LocateControl({position:"topright"})),l.on("locationfound",function(t){const o=L.marker(t.latlng).addTo(l).bindPopup((0,e.__)("Your are here!","sunflower-map-points-map")).openPopup();L.circle(t.latlng,{radius:t.accuracy,color:"#136aec",fillColor:"#136aec",fillOpacity:.2}).addTo(l),setTimeout(()=>{l.removeLayer(o)},2e3)}),l.on("locationerror",function(t){alert((0,e.__)("Your location couldn't be found.","sunflower-map-points-map")+"\n"+t.message)});let i=null,s=null;l.on("click",function(t){i=t.latlng.lat.toFixed(6),s=t.latlng.lng.toFixed(6);const o=L.icon({iconUrl:sunflowerMapPoints.maps_marker,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-25]});l._marker&&l.removeLayer(l._marker),l._marker=L.marker([i,s],{icon:o}).addTo(l),document.querySelector("#form-lat").value=i,document.querySelector("#form-lng").value=s,"undefined"!=typeof bootstrap&&"function"==typeof bootstrap.Modal?new bootstrap.Modal(document.getElementById("leafletModal")).show():console.log((0,e.__)("Bootstrap is not available","sunflower-map-points-map"))})});const t=document.getElementById("leafletModal");t&&(t.addEventListener("shown.bs.modal",()=>{const o=document.getElementById("leaflet-form");if(!o||"true"===o.dataset.handlerAttached)return;const n=document.getElementById("mini-map");if(n){const e=parseFloat(document.querySelector("#form-lat").value),t=parseFloat(document.querySelector("#form-lng").value);if(window.miniMap)window.miniMap.setView([e,t]),window.miniMarker&&window.miniMap.removeLayer(window.miniMarker),window.miniMarker=L.marker([e,t]).addTo(window.miniMap),window.miniMap.invalidateSize();else{window.miniMap=L.map(n,{center:[e,t],zoom:17,dragging:!1,scrollWheelZoom:!1,zoomControl:!1,attributionControl:!1}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(window.miniMap);const o=L.icon({iconUrl:sunflowerMapPoints.maps_marker,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-25]});window.miniMarker=L.marker([e,t],{icon:o}).addTo(window.miniMap)}}const a=document.querySelector("#map"),r=a?._leafletMap;o.addEventListener("submit",function(n){n.preventDefault();const a=new FormData(o),l=document.getElementById("form-message");l.classList.add("d-none","alert"),l.classList.remove("alert-success","alert-danger"),l.textContent="",fetch(sunflowerMapPoints.ajaxurl,{method:"POST",credentials:"same-origin",body:a}).then(e=>e.json()).then(n=>{n.success?(o.classList.add("d-none"),o.reset(),l.innerHTML=n?.messageafter,l.classList.remove("d-none"),l.classList.add("alert","alert-success"),setTimeout(()=>{if(t){const e=bootstrap.Modal.getInstance(t);e?.hide(),l.classList.add("d-none"),l.textContent="",o.classList.remove("d-none"),r?._marker&&(r.removeLayer(r._marker),r._marker=null)}},5e3)):(l.textContent=n?.messageafter||(0,e.__)("An error occured!","sunflower-map-points-map"),l.classList.remove("d-none"),l.classList.add("alert","alert-danger"))}).catch(()=>{l.textContent=(0,e.__)("Error on transmitting the form data.","sunflower-map-points-map"),l.classList.remove("d-none"),l.classList.add("alert","alert-danger")})}),o.dataset.handlerAttached="true"}),t.addEventListener("hidden.bs.modal",()=>{const e=document.getElementById("leaflet-form");e.dataset.handlerAttached="false",e.reset(),window.miniMap&&(window.miniMap.remove(),window.miniMap=null,window.miniMarker=null)}))}).observe(document.body,{childList:!0,subtree:!0})})})();